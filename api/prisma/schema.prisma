generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id       String  @id @default(uuid())
  name     String
  apiKey   String  @unique
  isActive Boolean @default(true)

  // Contract addresses for payment types
  dvpContractAddress           String? // DvP (Delivery vs Payment) contract address
  consentedPullContractAddress String? // Consented Pull contract address

  // Escrow contract mappings (for programmable payments)
  contractMerchantId String? // Numeric merchant ID in the escrow contract (stored as string for BigInt compatibility)
  merchantAddress    String? // On-chain merchant address for escrow contracts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  paymentIntents PaymentIntent[]
  fiatAccount    MerchantFiatAccount?
  escrowOrders   EscrowOrder[]
}

model PaymentIntent {
  id     String @id
  object String @default("payment_intent")
  status String

  // Merchant/Account
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  // Payment details
  amount      String
  currency    String
  type        String
  description String?

  // Settlement
  settlementMethod      String
  settlementDestination String
  settlementStatus      String?

  // Blockchain
  contractAddress String?
  transactionHash String?
  chainId         Int?

  // EIP-712
  typedData     Json?
  signature     String?
  signerAddress String?

  // Progress / phases (for Stripe-like status introspection)
  phases Json?

  // Metadata
  metadata Json?

  // Payment Processor (Web2 payments)
  paymentProcessorType   String? // 'mocked_stripe', etc.
  paymentProcessorTxId   String? // Payment processor transaction ID
  fiatPaymentStatus      String? // 'pending', 'succeeded', 'failed'
  fiatPaymentConfirmedAt DateTime?

  // On-Ramp (Fiat â†’ Crypto)
  onRampStatus       String? // 'pending', 'completed', 'failed'
  onRampTxId         String? // On-ramp transaction ID
  onRampCompletedAt  DateTime?
  stablecoinAmount   String? // Amount in stablecoins
  stablecoinCurrency String? // 'USDC'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit trail
  auditLogs AuditLog[]

  // Escrow order tracking (for programmable payments)
  escrowOrder EscrowOrder?
}

model AuditLog {
  id String @id @default(uuid())

  // Related entities
  paymentIntentId String
  paymentIntent   PaymentIntent @relation(fields: [paymentIntentId], references: [id], onDelete: Cascade)
  merchantId      String

  // Event type and category
  eventType String // e.g., "INTENT_CREATED", "BLOCKCHAIN_TX_SUBMITTED", "BLOCKCHAIN_TX_CONFIRMED", "SETTLEMENT_INITIATED", "SETTLEMENT_COMPLETED", "STATUS_CHANGED"
  category  String // "ON_CHAIN", "OFF_RAMP", "LIFECYCLE", "AUTHORIZATION"

  // Money movement details
  amount   String? // Amount involved in this event
  currency String? // Currency code

  // On-chain details
  blockchainTxHash   String? // Blockchain transaction hash
  blockchainTxStatus String? // "PENDING", "CONFIRMED", "FAILED"
  contractAddress    String? // Smart contract address
  chainId            Int? // Chain ID
  blockNumber        BigInt? // Block number (if confirmed)
  blockTimestamp     DateTime? // Block timestamp

  // Off-ramp/Settlement details
  settlementMethod      String? // Settlement method used
  settlementDestination String? // Where funds were settled
  settlementTxId        String? // Settlement transaction ID (from offramp provider)
  settlementStatus      String? // Settlement status

  // Event details
  fromStatus  String? // Previous status (for status changes)
  toStatus    String? // New status (for status changes)
  phase       String? // Payment phase (if applicable)
  phaseStatus String? // Phase status

  // Actor information
  actorType String? // "MERCHANT", "PAYER", "SYSTEM", "BLOCKCHAIN"
  actorId   String? // ID of the actor (merchant ID, payer address, etc.)

  // Additional context
  metadata Json? // Additional event-specific data

  // Timestamps
  createdAt DateTime @default(now())

  @@index([paymentIntentId])
  @@index([merchantId])
  @@index([eventType])
  @@index([category])
  @@index([blockchainTxHash])
  @@index([settlementTxId])
  @@index([createdAt])
}

// Simulated Fiat Account for Merchants
model MerchantFiatAccount {
  id                String   @id @default(uuid())
  merchantId        String   @unique
  currency          String   @default("USD") // USD, EUR, GBP, etc.
  availableBalance  String   @default("0") // Decimal as string for precision
  pendingBalance    String   @default("0") // Funds pending settlement
  reservedBalance   String   @default("0") // Funds reserved for in-flight transactions
  accountNumber     String   @unique // Simulated bank account number
  routingNumber     String? // For US accounts
  bankName          String? // Simulated bank name
  accountHolderName String? // Account holder name
  country           String   @default("US") // ISO country code
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  merchant      Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  ledgerEntries LedgerEntry[]

  @@index([merchantId])
  @@index([currency])
}

// Ledger entries for fiat account transactions
model LedgerEntry {
  id                    String   @id @default(uuid())
  fiatAccountId         String
  paymentIntentId       String?
  transactionType       String // "CREDIT", "DEBIT", "SETTLEMENT", "RESERVE", "RELEASE"
  amount                String // Decimal as string
  currency              String   @default("USD")
  balanceBefore         String // Balance before this transaction
  balanceAfter          String // Balance after this transaction
  description           String?
  settlementMethod      String? // "wire_transfer", "ach", "sepa", etc.
  settlementDestination String? // Bank account, wallet address, etc.
  settlementTxId        String? // Mock settlement transaction ID
  status                String   @default("COMPLETED") // "COMPLETED", "PENDING", "FAILED"
  metadata              Json? // Additional transaction details
  createdAt             DateTime @default(now())

  fiatAccount MerchantFiatAccount @relation(fields: [fiatAccountId], references: [id], onDelete: Cascade)

  @@index([fiatAccountId])
  @@index([paymentIntentId])
  @@index([transactionType])
  @@index([status])
  @@index([createdAt])
}

// Escrow Order - Maps PaymentIntent to contract orderId and tracks order lifecycle
model EscrowOrder {
  id              String @id @default(uuid())
  paymentIntentId String @unique // One-to-one with PaymentIntent
  orderId         String // Contract orderId (BigInt as string)
  merchantId      String
  contractAddress String // Escrow contract address

  // Order details
  buyerAddress         String // Buyer's wallet address
  tokenAddress         String // ERC-20 token address
  amount               String // Order amount (decimal as string)
  deliveryPeriod       Int // Delivery period in seconds
  deliveryDeadline     String // Unix timestamp (BigInt as string)
  expectedDeliveryHash String? // Expected delivery hash (bytes32)
  actualDeliveryHash   String? // Actual delivery hash from proof
  autoReleaseOnProof   Boolean @default(true)
  deliveryOracle       String? // Delivery oracle address (optional)

  // Release mechanism type (programmable payment support)
  releaseType   String  @default("DELIVERY_PROOF") // TIME_LOCKED, MILESTONE_LOCKED, DELIVERY_PROOF, AUTO_RELEASE
  timeLockUntil String? // Unix timestamp for time-locked releases (BigInt as string)

  // Order status tracking
  orderStatus      String @default("PENDING") // PENDING, SHIPPED, DELIVERED, COMPLETED, CANCELLED, DISPUTED
  settlementStatus String @default("NONE") // NONE, SCHEDULED, EXECUTED, CONFIRMED, CANCELLED

  // Dispute resolution
  disputeWindow           String? // Dispute window period in seconds (BigInt as string, from contract)
  disputeRaisedAt         String? // When dispute was raised (Unix timestamp)
  disputeReason           String? // Reason for dispute
  disputeRaisedBy         String? // Address that raised the dispute
  disputeResolvedAt       String? // When dispute was resolved (Unix timestamp)
  disputeResolution       String? // MERCHANT_WON, BUYER_WON, PARTIAL_REFUND
  disputeResolutionTxHash String? // Transaction hash of dispute resolution

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Blockchain transaction
  createTxHash          String? // Transaction hash that created the order
  releasedAt            String? // When funds were released (Unix timestamp)
  settlementScheduledAt String? // When settlement was scheduled (Unix timestamp)

  // Relations
  paymentIntent       PaymentIntent        @relation(fields: [paymentIntentId], references: [id], onDelete: Cascade)
  merchant            Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  deliveryProofs      DeliveryProof[]
  milestones          PaymentMilestone[]
  settlementExecution SettlementExecution?

  @@index([paymentIntentId])
  @@index([merchantId])
  @@index([orderId])
  @@index([orderStatus])
  @@index([settlementStatus])
  @@index([releaseType])
  @@index([contractAddress])
  @@index([buyerAddress])
  @@index([createdAt])
}

// Delivery Proof - Tracks delivery proofs submitted for escrow orders
model DeliveryProof {
  id              String @id @default(uuid())
  escrowOrderId   String
  paymentIntentId String // For convenience/indexing

  proofHash   String // Delivery proof hash (bytes32)
  proofURI    String? // URI to delivery proof (IPFS, HTTP, etc.)
  submittedBy String // Address that submitted the proof
  submittedAt String // Unix timestamp (BigInt as string)

  // Blockchain transaction
  submitTxHash String? // Transaction hash that submitted the proof

  createdAt DateTime @default(now())

  // Relations
  escrowOrder EscrowOrder @relation(fields: [escrowOrderId], references: [id], onDelete: Cascade)

  @@index([escrowOrderId])
  @@index([paymentIntentId])
  @@index([proofHash])
  @@index([submittedBy])
  @@index([createdAt])
}

// Settlement Execution - Tracks settlement executions for escrow orders
model SettlementExecution {
  id              String @id @default(uuid())
  escrowOrderId   String @unique // One-to-one with EscrowOrder
  paymentIntentId String // For convenience/indexing
  merchantId      String

  merchantAddress String // Merchant's on-chain address
  amount          String // Settlement amount (decimal as string)
  executedAt      String // Unix timestamp (BigInt as string)
  executedBy      String // Address that executed the settlement
  txHash          String? // Settlement transaction hash (bytes32)
  status          String  @default("EXECUTED") // EXECUTED, CONFIRMED, CANCELLED

  // Off-ramp details
  offrampDestination String? // Destination address for off-ramp
  offrampData        String? // Off-ramp data (bytes, stored as hex string)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  escrowOrder EscrowOrder @relation(fields: [escrowOrderId], references: [id], onDelete: Cascade)

  @@index([escrowOrderId])
  @@index([paymentIntentId])
  @@index([merchantId])
  @@index([txHash])
  @@index([status])
  @@index([createdAt])
}

// Payment Milestone - Tracks milestone-based releases for programmable payments
model PaymentMilestone {
  id              String @id @default(uuid())
  escrowOrderId   String
  paymentIntentId String // For convenience/indexing

  milestoneIndex Int // Order of milestone (0, 1, 2, ...)
  description    String? // Milestone description
  amount         String // Amount to be released for this milestone (decimal as string)
  percentage     Int? // Percentage of total amount (optional, for clarity)

  // Milestone status
  status             String  @default("PENDING") // PENDING, COMPLETED, RELEASED, CANCELLED
  completionProof    String? // Proof of milestone completion (hash, URI, etc.)
  completionProofURI String? // URI to completion proof (IPFS, HTTP, etc.)

  // Release tracking
  releasedAt    String? // When milestone amount was released (Unix timestamp)
  releaseTxHash String? // Transaction hash that released milestone funds
  releasedBy    String? // Address that triggered the release

  // Completion tracking
  completedAt String? // When milestone was marked complete (Unix timestamp)
  completedBy String? // Address that marked milestone complete

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  escrowOrder EscrowOrder @relation(fields: [escrowOrderId], references: [id], onDelete: Cascade)

  @@unique([escrowOrderId, milestoneIndex]) // Ensure unique milestone indices per order
  @@index([escrowOrderId])
  @@index([paymentIntentId])
  @@index([status])
  @@index([createdAt])
}
